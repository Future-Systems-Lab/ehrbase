name: "Collect JUnit Results"

# we have multiple workflows - this helps to distinguish for them
run-name: "${{ github.event.pull_request.title && github.event.pull_request.title || github.ref_name }} - Collect JUnit Results"

on:
  workflow_run:
    workflows: ['Build & Test'] # runs after build and test workflow
    types:
      - completed

permissions:
  contents: read
  actions: read
  checks: write

#
# see https://github.com/dorny/test-reporter?tab=readme-ov-file#recommended-setup-for-public-repositories
#
jobs:
  #
  # Collect Junit reports generated by build_and_test
  #
  collect-junit-reports:
    runs-on: ubuntu-latest
    steps:
      - name: Collect - JUnit Reports
        uses: dorny/test-reporter@v1
        # Dependabot has not enough rights to add the report to the run.
        if: ${{ github.actor != 'dependabot[bot]' }}
        with:
          name: Unit Tests
          artifact: junit-test-results  # uses artifact of build and test workflow
          path: '**/target/surefire-reports/*.xml'
          reporter: java-junit
          fail-on-error: 'true'
          fail-on-empty: 'true'

  #
  # Cleanup serialized oci image as well as intermediate robot results
  #
  cleanup:
    name: Cleanup
    if: ${{ always() }}
    needs: [
      docker-build-push,
      maven-publish
    ]
    runs-on: ubuntu-latest
    steps:
      - name: Delete - Temp Artifacts
        uses: geekyeggo/delete-artifact@v5
        with:
          name: junit-test-results
          failOnError: false

