version: '3'

#
# Extended setup for EHRbase for integration tests.
#
services:

  #
  # Configure ehrbase container to contain a healthcheck.
  #
  ehrbase:
    environment:
      MANAGEMENT_ENDPOINTS_WEB_ACCESS: "PUBLIC"
      MANAGEMENT_ENDPOINT_INFO_ENABLED: "true"
      SERVER_NODENAME: "local.ehrbase.org"
      EHRBASE_REST_AQL_RESPONSE_GENERATOR_DETAILS_ENABLED: "true"

      SECURITY_AUTHTYPE: "NONE"
    healthcheck:
      test: [ "CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/ehrbase/management/info || exit 1" ]
      interval: 5s
      timeout: 5s
      retries: 12

  #
  # Integration tests will be ready after ehrbase is healthy.
  # Will run `runRobotTests`
  #
  ehrbase-integration-tests:
    image: ${EHRBASE_INTEGRATION_TEST_IMAGE:-ehrbase/integration-tests:latest}
    container_name: "EHRbase-IT"
    environment:
      EHRBASE_BASE_URL: http://ehrbase:8080
      SERVER_NODENAME: "local.ehrbase.org"
    depends_on:
      ehrbase:
        condition: service_healthy
    links:
      - ehrbase
      - ehrdb
    networks:
      - ehrbase-net
    volumes:
      - ./tests/runRobotTests.sh:/bin/runRobotTests:Z
      - ./tests/results:/integration-tests/tests/results
    command: bash -c 'chmod +x /bin/runRobotTests && echo "ready to run runRobotTests"'
